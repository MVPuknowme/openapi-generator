version: 2.1

commands:
  command_build_and_test:
    parameters:
      nodeNo:
        type: string
        default: "0"
    steps:
      - restore_cache:
          keys:
            - source-v2-{{ .Branch }}-{{ .Revision }}
            - source-v2-{{ .Branch }}-
            - source-v2-

      - checkout

      - run:
          name: Start Docker (safe)
          command: |
            sudo systemctl start docker || true
            docker info

      - run:
          name: Install Headless Chrome deps
          command: |
            sudo apt-get update
            sudo apt-get install -yq \
              gconf-service libasound2 libatk1.0-0 libatk-bridge2.0-0 \
              libgtk-3-0 libnss3 libxss1 libgbm1 fonts-liberation wget

      - run: mkdir -p $CIRCLE_ARTIFACTS $CIRCLE_TEST_REPORTS

      - run:
          name: Setup hosts for OpenAPI tests
          command: |
            echo "127.0.0.1 path.v1.test.openapi-generator.tech" | sudo tee -a /etc/hosts
            echo "127.0.0.1 operation.v1.test.openapi-generator.tech" | sudo tee -a /etc/hosts
            echo "127.0.0.1 server.v1.test.openapi-generator.tech" | sudo tee -a /etc/hosts
            echo "127.0.0.1 petstore.swagger.io" | sudo tee -a /etc/hosts

      - run:
          name: Start Petstore container
          command: |
            docker pull swaggerapi/petstore
            docker run -d \
              --name petstore.swagger \
              -e SWAGGER_HOST=http://petstore.swagger.io \
              -e SWAGGER_BASE_PATH=/v2 \
              -p 80:8080 swaggerapi/petstore

      - run:
          name: Wait for container readiness
          command: |
            echo "Waiting for petstore..."
            until curl -s http://localhost/v2/swagger.json; do
              sleep 2
            done
